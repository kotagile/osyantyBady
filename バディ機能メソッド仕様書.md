# バディ関連機能メソッド仕様書

## 1. 概要

本仕様書は、運動バディアプリのバディ関連機能（バディ検索・追加・リクエスト・承認・拒否・一覧・解除・進捗取得・運動完了報告へのリアクション等）に関する全てのメソッドについて、入力パラメータ、具体的処理内容、出力パラメータを詳細に記述したものです。

### 1.1 対象クラス
- `BuddyController` - バディ機能のコントローラー
- `BuddyService` - バディ機能のビジネスロジック
- `UserBuddyRepository` - バディ関係のデータアクセス層
- `UserBuddy` - バディ関係エンティティ
- `ProgressDto` - バディ進捗DTO

---

## 2. BuddyController クラス

### 2.1 クラス概要
バディ機能のHTTPリクエストを処理するコントローラークラスです。

### 2.2 メソッド仕様

#### 2.2.1 showBuddyList()
**概要**: バディ一覧画面を表示

**入力パラメータ**:
- `Model model` - Spring MVCのモデル
- `HttpSession session` - HTTPセッション

**具体的処理内容**:
1. セッションからユーザーIDを取得
2. 未ログインの場合はログイン画面にリダイレクト
3. BuddyServiceのgetBuddyListPageDataを呼び出し、バディ一覧・保留リクエスト・ユーザー名・エラーを取得
4. モデルにデータを追加し、一覧画面を返却

**出力パラメータ**:
- 戻り値: `String` - テンプレート名（"buddy/list" または "redirect:/login"）

---

#### 2.2.2 showBuddySearch()
**概要**: バディ検索画面を表示

**入力パラメータ**:
- `Model model` - Spring MVCのモデル
- `HttpSession session` - HTTPセッション

**具体的処理内容**:
1. セッションからユーザーIDを取得
2. 未ログインの場合はログイン画面にリダイレクト
3. ユーザー名をモデルに追加し、検索画面を返却

**出力パラメータ**:
- 戻り値: `String` - テンプレート名（"buddy/search" または "redirect:/login"）

---

#### 2.2.3 searchBuddies()
**概要**: バディ検索処理

**入力パラメータ**:
- `String searchTerm` - 検索キーワード
- `Model model` - Spring MVCのモデル
- `HttpSession session` - HTTPセッション

**具体的処理内容**:
1. セッションからユーザーIDを取得
2. 未ログインの場合はログイン画面にリダイレクト
3. BuddyServiceのsearchBuddiesを呼び出し、検索結果・ユーザー名・エラーを取得
4. モデルにデータを追加し、検索画面を返却

**出力パラメータ**:
- 戻り値: `String` - テンプレート名（"buddy/search" または "redirect:/login"）

---

#### 2.2.4 sendBuddyRequest()
**概要**: バディリクエスト送信

**入力パラメータ**:
- `String requestedUserId` - リクエスト送信先ユーザーID
- `HttpSession session` - HTTPセッション
- `RedirectAttributes redirectAttributes` - リダイレクト時の属性

**具体的処理内容**:
1. セッションからリクエスト送信者IDを取得
2. 未ログインの場合はログイン画面にリダイレクト
3. BuddyServiceのtrySendBuddyRequestを呼び出し、結果を取得
4. 成功時：成功メッセージを設定し検索画面にリダイレクト
5. 失敗時：エラーメッセージを設定し検索画面にリダイレクト

**出力パラメータ**:
- 戻り値: `String` - リダイレクト先のURL

---

#### 2.2.5 acceptBuddyRequest()
**概要**: バディリクエスト承認

**入力パラメータ**:
- `Long buddyId` - バディリクエストID
- `HttpSession session` - HTTPセッション
- `RedirectAttributes redirectAttributes` - リダイレクト時の属性

**具体的処理内容**:
1. セッションからユーザーIDを取得
2. 未ログインの場合はログイン画面にリダイレクト
3. BuddyServiceのtryAcceptBuddyRequestを呼び出し、結果を取得
4. 成功時：成功メッセージを設定し一覧画面にリダイレクト
5. 失敗時：エラーメッセージを設定し一覧画面にリダイレクト

**出力パラメータ**:
- 戻り値: `String` - リダイレクト先のURL

---

#### 2.2.6 rejectBuddyRequest()
**概要**: バディリクエスト拒否

**入力パラメータ**:
- `Long buddyId` - バディリクエストID
- `HttpSession session` - HTTPセッション
- `RedirectAttributes redirectAttributes` - リダイレクト時の属性

**具体的処理内容**:
1. セッションからユーザーIDを取得
2. 未ログインの場合はログイン画面にリダイレクト
3. BuddyServiceのtryRejectBuddyRequestを呼び出し、結果を取得
4. 成功時：成功メッセージを設定し一覧画面にリダイレクト
5. 失敗時：エラーメッセージを設定し一覧画面にリダイレクト

**出力パラメータ**:
- 戻り値: `String` - リダイレクト先のURL

---

#### 2.2.7 removeBuddy()
**概要**: バディ関係解除

**入力パラメータ**:
- `String buddyId` - バディ相手のユーザーID
- `HttpSession session` - HTTPセッション
- `RedirectAttributes redirectAttributes` - リダイレクト時の属性

**具体的処理内容**:
1. セッションからユーザーIDを取得
2. 未ログインの場合はログイン画面にリダイレクト
3. BuddyServiceのtryRemoveBuddyを呼び出し、結果を取得
4. 成功時：成功メッセージを設定し一覧画面にリダイレクト
5. 失敗時：エラーメッセージを設定し一覧画面にリダイレクト

**出力パラメータ**:
- 戻り値: `String` - リダイレクト先のURL

---

## 3. BuddyService クラス

### 3.1 クラス概要
バディ機能のビジネスロジックを提供するサービスクラスです。

### 3.2 メソッド仕様

#### 3.2.1 sendBuddyRequest()
**概要**: バディリクエスト送信

**入力パラメータ**:
- `String requesterId` - リクエスト送信者ID
- `String requestedId` - リクエスト受信者ID

**具体的処理内容**:
1. 受信者ユーザーの存在確認
2. 自分自身へのリクエストチェック
3. 保留中リクエストの重複チェック
4. 既存バディ関係のチェック
5. バディリクエストエンティティ作成・保存
6. 通知送信

**出力パラメータ**:
- 戻り値: `void`（例外発生時はRuntimeException）

---

#### 3.2.2 acceptBuddyRequest()
**概要**: バディリクエスト承認

**入力パラメータ**:
- `Long buddyId` - バディリクエストID

**具体的処理内容**:
1. バディリクエストエンティティ取得
2. ステータスが"pending"かチェック
3. ステータスを"accepted"に更新
4. 承認日時を設定
5. 保存
6. 承認通知送信

**出力パラメータ**:
- 戻り値: `void`（例外発生時はRuntimeException）

---

#### 3.2.3 rejectBuddyRequest()
**概要**: バディリクエスト拒否

**入力パラメータ**:
- `Long buddyId` - バディリクエストID

**具体的処理内容**:
1. バディリクエストエンティティ取得
2. ステータスが"pending"かチェック
3. ステータスを"rejected"に更新
4. 拒否日時を設定
5. 保存

**出力パラメータ**:
- 戻り値: `void`（例外発生時はRuntimeException）

---

#### 3.2.4 getBuddyList()
**概要**: バディ一覧取得

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. 承認済みバディ関係を全件取得
2. 相手ユーザー情報を取得しリスト化

**出力パラメータ**:
- 戻り値: `List<User>` - バディユーザーリスト

---

#### 3.2.5 getBuddyProgress()
**概要**: バディ進捗取得

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. バディ一覧を取得
2. 各バディの週間進捗情報（ProgressDto）を取得
3. 目標未設定時はデフォルト値を返却

**出力パラメータ**:
- 戻り値: `List<ProgressDto>` - バディ進捗リスト

---

#### 3.2.6 getPendingRequests()
**概要**: 保留中のリクエスト一覧取得

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. 保留中のバディリクエストを全件取得

**出力パラメータ**:
- 戻り値: `List<UserBuddy>` - 保留中リクエストリスト

---

#### 3.2.7 removeBuddy()
**概要**: バディ関係解除

**入力パラメータ**:
- `String userId` - ユーザーID
- `String buddyId` - バディ相手のユーザーID

**具体的処理内容**:
1. 承認済みバディ関係を全件取得
2. 指定ユーザーとの関係を検索
3. 見つかった場合は削除

**出力パラメータ**:
- 戻り値: `void`（例外発生時はRuntimeException）

---

#### 3.2.8 getBuddyListPageData()
**概要**: バディ一覧画面用データ取得

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. バディ一覧・保留リクエスト・ユーザー名を取得
2. DTOにまとめて返却

**出力パラメータ**:
- 戻り値: `BuddyListResult` - バディ一覧・保留リクエスト・ユーザー名・エラー

---

#### 3.2.9 searchBuddies()
**概要**: バディ検索

**入力パラメータ**:
- `String userId` - 検索実行ユーザーID
- `String searchTerm` - 検索キーワード

**具体的処理内容**:
1. ユーザーID完全一致で検索
2. 自分自身を除外
3. DTOにまとめて返却

**出力パラメータ**:
- 戻り値: `BuddySearchResult` - 検索結果・ユーザー名・エラー

---

#### 3.2.10 trySendBuddyRequest()/tryAcceptBuddyRequest()/tryRejectBuddyRequest()/tryRemoveBuddy()
**概要**: 各アクションの例外ラップ・結果DTO返却

**入力パラメータ**:
- 各アクションに応じたパラメータ

**具体的処理内容**:
1. 各アクションメソッドを呼び出し
2. 成功時：ActionResult（success=true, error=null）
3. 失敗時：ActionResult（success=false, error=エラーメッセージ）

**出力パラメータ**:
- 戻り値: `ActionResult` - 成功フラグ・エラーメッセージ

---

## 4. UserBuddyRepository クラス

### 4.1 クラス概要
バディ関係のデータベースアクセスを担当するリポジトリクラスです。

### 4.2 メソッド仕様

#### 4.2.1 findByRequesterIdAndRequestedId()
**概要**: リクエスト送信者と受信者でバディ関係を検索

**入力パラメータ**:
- `String requesterId` - 送信者ID
- `String requestedId` - 受信者ID

**具体的処理内容**:
1. 両者のバディ関係を検索
2. 結果を返却

**出力パラメータ**:
- 戻り値: `Optional<UserBuddy>` - バディ関係（存在しない場合は空）

---

#### 4.2.2 findAcceptedBuddiesByUserId()
**概要**: ユーザーIDで承認済みバディ一覧を取得

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. 指定ユーザーの承認済みバディ関係を全件取得

**出力パラメータ**:
- 戻り値: `List<UserBuddy>` - 承認済みバディ関係リスト

---

#### 4.2.3 findPendingRequestsByUserId()
**概要**: ユーザーIDで保留中のリクエスト一覧を取得

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. 指定ユーザー宛の保留中リクエストを全件取得

**出力パラメータ**:
- 戻り値: `List<UserBuddy>` - 保留中リクエストリスト

---

#### 4.2.4 existsPendingRequest()
**概要**: 保留中のリクエストが存在するかチェック

**入力パラメータ**:
- `String requesterId` - 送信者ID
- `String requestedId` - 受信者ID

**具体的処理内容**:
1. 両者間の保留中リクエストの有無をカウント

**出力パラメータ**:
- 戻り値: `boolean` - 存在する場合true

---

#### 4.2.5 areBuddies()
**概要**: バディ関係が存在するかチェック

**入力パラメータ**:
- `String userId1` - ユーザーID1
- `String userId2` - ユーザーID2

**具体的処理内容**:
1. 両者間の承認済みバディ関係の有無をカウント

**出力パラメータ**:
- 戻り値: `boolean` - 存在する場合true

---

#### 4.2.6 save()
**概要**: バディ関係を保存

**入力パラメータ**:
- `UserBuddy userBuddy` - バディ関係エンティティ

**具体的処理内容**:
1. 新規作成時はINSERT、既存時はUPDATE
2. 保存後のエンティティを返却

**出力パラメータ**:
- 戻り値: `UserBuddy` - 保存されたエンティティ

---

#### 4.2.7 delete()
**概要**: バディ関係を削除

**入力パラメータ**:
- `UserBuddy userBuddy` - バディ関係エンティティ

**具体的処理内容**:
1. 指定エンティティをDELETE

**出力パラメータ**:
- 戻り値: なし

---

#### 4.2.8 findById()
**概要**: IDでバディ関係を取得

**入力パラメータ**:
- `Long buddyId` - バディID

**具体的処理内容**:
1. 指定IDのバディ関係を取得

**出力パラメータ**:
- 戻り値: `Optional<UserBuddy>` - バディ関係（存在しない場合は空）

---

## 5. UserBuddy エンティティ

### 5.1 クラス概要
ユーザー間のバディ関係を表現するエンティティクラスです。

### 5.2 フィールド仕様
- `buddyId`: バディ関係ID（Long）
- `requesterId`: リクエスト送信者ID（String）
- `requestedId`: リクエスト受信者ID（String）
- `status`: ステータス（pending, accepted, rejected）（String）
- `requestedAt`: リクエスト送信日時（LocalDateTime）
- `respondedAt`: 承認/拒否日時（LocalDateTime）
- `requester`: 送信者ユーザー情報（User）
- `requested`: 受信者ユーザー情報（User）

---

## 6. ProgressDto クラス

### 6.1 クラス概要
バディ進捗情報を表現するDTOクラスです。

### 6.2 フィールド仕様
- `userId`: ユーザーID
- `userName`: ユーザー名
- `totalWorkouts`: 運動回数
- `completedWorkouts`: 完了回数または進捗率
- `totalMinutes`: 総運動時間
- `goalFrequency`: 目標頻度
- `goalSessionTime`: 目標セッション時間

---

**作成者**: nagahama  
**作成日**: 2024年1月1日  
**バージョン**: 1.0 