# 運動管理機能メソッド仕様書

## 1. 概要

本仕様書は、運動バディアプリの運動管理機能に関連するすべてのメソッドについて、入力パラメータ、具体的処理内容、出力パラメータを詳細に記述したものです。

### 1.1 対象クラス
- `WorkoutController` - 運動管理機能のコントローラー
- `WorkoutService` - 運動管理機能のビジネスロジック
- `WorkoutRepository` - 運動記録のデータアクセス層
- `Workout` - 運動記録エンティティ
- `WorkoutDto` - 運動記録データ転送オブジェクト

### 1.2 運動管理機能の概要
運動管理機能は、ユーザーの運動セッションの開始から完了までを管理し、進捗の計算やバディへの通知を行う機能です。

---

## 2. WorkoutController クラス

### 2.1 クラス概要
運動管理機能のHTTPリクエストを処理するコントローラークラスです。

### 2.2 エンドポイント一覧

| メソッド | HTTPメソッド | エンドポイント | 概要 |
|---------|-------------|---------------|------|
| showWorkoutStart | GET | `/workout/start` | 運動開始画面表示 |
| startWorkout | POST | `/workout/start` | 運動開始処理 |
| startWorkoutWithGoal | POST | `/workout/start/goal` | 目標運動種別で運動開始 |
| showWorkoutInProgress | GET | `/workout/in-progress` | 運動進行中画面表示 |
| showWorkoutComplete | GET | `/workout/complete` | 運動完了画面表示 |
| completeWorkout | POST | `/workout/complete` | 運動完了処理 |
| sendReaction | POST | `/workout/reaction` | リアクション送信 |
| showWorkoutRecords | GET | `/workout/records` | 運動記録一覧表示 |

### 2.3 メソッド仕様

#### 2.3.1 showWorkoutStart()
**概要**: 運動開始画面を表示

**エンドポイント**: `GET /workout/start`

**入力パラメータ**:
- `Model model` - Spring MVCのモデル
- `HttpSession session` - HTTPセッション

**具体的処理内容**:
1. セッションからユーザーIDを取得
2. ユーザーがログインしていない場合はログイン画面にリダイレクト
3. ユーザー名を取得してモデルに追加
4. 運動開始画面のテンプレート名を返却

**出力パラメータ**:
- 戻り値: `String` - テンプレート名（"workout/start" または "redirect:/login"）

**例外処理**:
- ユーザーがログインしていない場合: ログイン画面にリダイレクト

**テンプレート**: `workout/start.html`

---

#### 2.3.2 startWorkout()
**概要**: 運動を開始

**エンドポイント**: `POST /workout/start`

**入力パラメータ**:
- `String exerciseType` - 運動種別（例：ランニング、筋トレ）
- `HttpSession session` - HTTPセッション
- `RedirectAttributes redirectAttributes` - リダイレクト時の属性

**具体的処理内容**:
1. セッションからユーザーIDを取得
2. ユーザーがログインしていない場合はログイン画面にリダイレクト
3. WorkoutServiceのtryStartWorkoutメソッドを呼び出し
4. 成功時：セッションに運動IDを保存し、進行中画面にリダイレクト
5. 失敗時：エラーメッセージを設定し、開始画面にリダイレクト

**出力パラメータ**:
- 戻り値: `String` - リダイレクト先のURL

**例外処理**:
- ユーザーがログインしていない場合: ログイン画面にリダイレクト
- 運動開始に失敗した場合: エラーメッセージと共に開始画面にリダイレクト

**リダイレクト先**:
- 成功時: `/workout/in-progress`
- 失敗時: `/workout/start`

---

#### 2.3.3 startWorkoutWithGoal()
**概要**: 目標の運動種別で運動を開始

**エンドポイント**: `POST /workout/start/goal`

**入力パラメータ**:
- `HttpSession session` - HTTPセッション
- `RedirectAttributes redirectAttributes` - リダイレクト時の属性

**具体的処理内容**:
1. セッションからユーザーIDを取得
2. ユーザーがログインしていない場合はログイン画面にリダイレクト
3. WorkoutServiceのtryStartWorkoutWithGoalメソッドを呼び出し
4. 成功時：セッションに運動IDを保存し、進行中画面にリダイレクト
5. 失敗時：エラーメッセージを設定し、目標設定画面にリダイレクト

**出力パラメータ**:
- 戻り値: `String` - リダイレクト先のURL

**例外処理**:
- ユーザーがログインしていない場合: ログイン画面にリダイレクト
- 目標が設定されていない場合: 目標設定画面にリダイレクト

**リダイレクト先**:
- 成功時: `/workout/in-progress`
- 失敗時: `/goal/set`

---

#### 2.3.4 showWorkoutInProgress()
**概要**: 運動進行中画面を表示

**エンドポイント**: `GET /workout/in-progress`

**入力パラメータ**:
- `Model model` - Spring MVCのモデル
- `HttpSession session` - HTTPセッション

**具体的処理内容**:
1. セッションからユーザーIDと運動IDを取得
2. ユーザーIDまたは運動IDが存在しない場合はホーム画面にリダイレクト
3. WorkoutServiceのgetInProgressDataメソッドを呼び出し
4. 有効なデータの場合：運動情報、目標時間、ユーザー名をモデルに追加
5. 無効なデータの場合：ホーム画面にリダイレクト

**出力パラメータ**:
- 戻り値: `String` - テンプレート名（"workout/in-progress" または "redirect:/"）

**例外処理**:
- ユーザーIDまたは運動IDが存在しない場合: ホーム画面にリダイレクト
- 無効な運動データの場合: ホーム画面にリダイレクト

**テンプレート**: `workout/in-progress.html`

---

#### 2.3.5 showWorkoutComplete()
**概要**: 運動完了画面を表示

**エンドポイント**: `GET /workout/complete`

**入力パラメータ**:
- `Model model` - Spring MVCのモデル
- `HttpSession session` - HTTPセッション

**具体的処理内容**:
1. セッションからユーザーIDと運動IDを取得
2. ユーザーIDまたは運動IDが存在しない場合はホーム画面にリダイレクト
3. WorkoutServiceのgetCompleteDataメソッドを呼び出し
4. 有効なデータの場合：運動情報と運動時間をモデルに追加
5. 無効なデータの場合：ホーム画面にリダイレクト

**出力パラメータ**:
- 戻り値: `String` - テンプレート名（"workout/complete" または "redirect:/"）

**例外処理**:
- ユーザーIDまたは運動IDが存在しない場合: ホーム画面にリダイレクト
- 無効な運動データの場合: ホーム画面にリダイレクト

**テンプレート**: `workout/complete.html`

---

#### 2.3.6 completeWorkout()
**概要**: 運動を完了

**エンドポイント**: `POST /workout/complete`

**入力パラメータ**:
- `String comment` - 運動に関するコメント
- `HttpSession session` - HTTPセッション
- `RedirectAttributes redirectAttributes` - リダイレクト時の属性

**具体的処理内容**:
1. セッションからユーザーIDと運動IDを取得
2. ユーザーIDまたは運動IDが存在しない場合はホーム画面にリダイレクト
3. WorkoutServiceのtryCompleteWorkoutメソッドを呼び出し
4. 成功時：セッションから運動IDを削除し、成功メッセージを設定してホーム画面にリダイレクト
5. 失敗時：エラーメッセージを設定し、進行中画面にリダイレクト

**出力パラメータ**:
- 戻り値: `String` - リダイレクト先のURL

**例外処理**:
- ユーザーIDまたは運動IDが存在しない場合: ホーム画面にリダイレクト
- 運動完了に失敗した場合: エラーメッセージと共に進行中画面にリダイレクト

**リダイレクト先**:
- 成功時: `/` (ホーム画面)
- 失敗時: `/workout/in-progress`

---

#### 2.3.7 sendReaction()
**概要**: 運動にリアクションを送信

**エンドポイント**: `POST /workout/reaction`

**リクエストボディ**:
```json
{
  "workoutId": "運動ID",
  "reactionType": "リアクション種別"
}
```

**入力パラメータ**:
- `Map<String, Object> request` - リアクション情報を含むリクエストマップ
- `HttpSession session` - HTTPセッション

**具体的処理内容**:
1. セッションからユーザーIDを取得
2. ユーザーがログインしていない場合はエラーレスポンスを返却
3. WorkoutServiceのtryAddReactionメソッドを呼び出し
4. 結果をJSONレスポンスとして返却

**出力パラメータ**:
- 戻り値: `ResponseEntity<Map<String, Object>>` - JSONレスポンス
  - `success`: 成功フラグ（boolean）
  - `message`: 結果メッセージ（String）

**例外処理**:
- ユーザーがログインしていない場合: エラーレスポンスを返却
- リアクション送信に失敗した場合: エラーレスポンスを返却

**レスポンス例**:
```json
{
  "success": true,
  "message": "リアクションを送信しました"
}
```

---

#### 2.3.8 showWorkoutRecords()
**概要**: 運動記録一覧画面を表示

**エンドポイント**: `GET /workout/records`

**入力パラメータ**:
- `Model model` - Spring MVCのモデル
- `HttpSession session` - HTTPセッション

**具体的処理内容**:
1. セッションからユーザーIDを取得
2. ユーザーがログインしていない場合はログイン画面にリダイレクト
3. WorkoutServiceのgetRecordsDataメソッドを呼び出し
4. 運動記録リストとユーザー名をモデルに追加

**出力パラメータ**:
- 戻り値: `String` - テンプレート名（"workout/records" または "redirect:/login"）

**例外処理**:
- ユーザーがログインしていない場合: ログイン画面にリダイレクト

**テンプレート**: `workout/records.html`

---

## 3. WorkoutService クラス

### 3.1 クラス概要
運動管理機能のビジネスロジックを提供するサービスクラスです。

### 3.2 メソッド仕様

#### 3.2.1 startWorkout()
**概要**: 運動を開始

**入力パラメータ**:
- `String userId` - ユーザーID
- `String exerciseType` - 運動種別（例：ランニング、筋トレ、ウォーキング）

**具体的処理内容**:
1. ユーザーのアクティブな目標を取得（存在チェック）
2. 進行中の運動があるかチェック
3. 新しい運動記録を作成
   - 一意の運動IDを生成
   - 現在日時を運動日と開始時刻に設定
   - 運動種別を設定
   - ステータスを"in_progress"に設定
4. 運動記録をデータベースに保存

**出力パラメータ**:
- 戻り値: `Workout` - 作成された運動記録

**例外処理**:
- アクティブな目標が設定されていない場合: RuntimeException
- 既に進行中の運動がある場合: RuntimeException

---

#### 3.2.2 getUserTargetSessionTime()
**概要**: ユーザーの目標運動時間を取得（分）

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. ユーザーのアクティブな目標を取得
2. 目標のセッション時間（分）を返却

**出力パラメータ**:
- 戻り値: `int` - 目標運動時間（分）

**例外処理**:
- アクティブな目標が設定されていない場合: RuntimeException

---

#### 3.2.3 getUserTargetExerciseType()
**概要**: ユーザーの目標運動種別を取得

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. ユーザーのアクティブな目標を取得
2. 目標の運動種別を返却

**出力パラメータ**:
- 戻り値: `String` - 目標運動種別

**例外処理**:
- アクティブな目標が設定されていない場合: RuntimeException

---

#### 3.2.4 getCurrentWorkout()
**概要**: 進行中の運動記録を取得

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. 指定されたユーザーの進行中（"in_progress"）の運動記録を検索
2. 結果を返却（存在しない場合は空のOptional）

**出力パラメータ**:
- 戻り値: `Optional<Workout>` - 進行中の運動記録（存在しない場合は空）

---

#### 3.2.5 completeWorkout()
**概要**: 運動を完了

**入力パラメータ**:
- `String workoutId` - 運動ID
- `String comment` - 運動に関するコメント

**具体的処理内容**:
1. 指定された運動IDの運動記録を取得
2. 運動ステータスが"in_progress"かチェック
3. 現在時刻を終了時刻として設定
4. 開始時刻から終了時刻までの時間を計算（秒）
5. 運動記録を更新
   - 終了時刻を設定
   - 運動時間（秒）を設定
   - コメントを設定
   - ステータスを"completed"に変更
6. 更新された運動記録を保存
7. バディへの通知を送信

**出力パラメータ**:
- 戻り値: `Workout` - 更新された運動記録

**例外処理**:
- 運動記録が見つからない場合: RuntimeException
- 完了できない運動ステータスの場合: RuntimeException

---

#### 3.2.6 getWeeklyProgress()
**概要**: 週間進捗を計算

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. ユーザーのアクティブな目標を取得
2. 今週の期間を計算（月曜日から日曜日）
3. 期間内の運動日数を取得（重複排除）
4. 進捗率を計算（運動日数 / 目標頻度 × 100、最大100%）
5. 進捗率に応じた励ましメッセージを生成
6. ProgressDtoを作成して返却

**出力パラメータ**:
- 戻り値: `ProgressDto` - 週間進捗情報
  - `currentCount`: 現在の運動日数
  - `targetCount`: 目標運動日数
  - `percentage`: 進捗率（%）
  - `message`: 励ましメッセージ

**例外処理**:
- 目標が設定されていない場合: RuntimeException

---

#### 3.2.7 getUserWorkouts()
**概要**: ユーザーの運動記録を取得

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. 指定されたユーザーの運動記録を運動日の降順で取得
2. 結果を返却

**出力パラメータ**:
- 戻り値: `List<Workout>` - 運動記録のリスト（運動日降順）

---

#### 3.2.8 getWorkout()
**概要**: 運動記録を取得

**入力パラメータ**:
- `String workoutId` - 運動ID

**具体的処理内容**:
1. 指定された運動IDの運動記録を取得
2. 結果を返却（存在しない場合は空のOptional）

**出力パラメータ**:
- 戻り値: `Optional<Workout>` - 運動記録（存在しない場合は空）

---

#### 3.2.9 findById()
**概要**: ワークアウトIDでワークアウトを取得

**入力パラメータ**:
- `String workoutId` - 運動ID

**具体的処理内容**:
1. 指定された運動IDの運動記録を取得
2. 結果を返却（存在しない場合は空のOptional）

**出力パラメータ**:
- 戻り値: `Optional<Workout>` - 運動記録（存在しない場合は空）

---

#### 3.2.10 addReaction()
**概要**: ワークアウトにリアクションを追加

**入力パラメータ**:
- `String workoutId` - 運動ID
- `String userId` - リアクション送信者ID
- `String reactionType` - リアクション種別（like, great, fire等）

**具体的処理内容**:
1. 指定された運動IDの運動記録を取得
2. 現在のコメントにリアクション情報を追記
3. 更新された運動記録を保存

**出力パラメータ**:
- 戻り値: `void`

**例外処理**:
- ワークアウトが見つからない場合: RuntimeException

---

#### 3.2.11 generateEncouragementMessage()
**概要**: 励ましメッセージを生成

**入力パラメータ**:
- `int progressPercentage` - 進捗率（0-100）

**具体的処理内容**:
1. 進捗率に応じて適切な励ましメッセージを生成
   - 100%以上: "目標達成！素晴らしいです！"
   - 80%以上: "もう少しです！がんばりましょう！"
   - 50%以上: "良いペースです！続けましょう！"
   - 20%以上: "コツコツ頑張りましょう！"
   - それ以外: "今週も運動を始めましょう！"

**出力パラメータ**:
- 戻り値: `String` - 励ましメッセージ

---

#### 3.2.12 tryStartWorkout()
**概要**: 運動開始を試行

**入力パラメータ**:
- `String userId` - ユーザーID
- `String exerciseType` - 運動種別

**具体的処理内容**:
1. startWorkoutメソッドを呼び出し
2. 成功時：StartWorkoutResult（成功=true、運動ID、エラー=null）を返却
3. 失敗時：StartWorkoutResult（成功=false、運動ID=null、エラーメッセージ）を返却

**出力パラメータ**:
- 戻り値: `StartWorkoutResult` - 運動開始結果
  - `success`: 成功フラグ（boolean）
  - `workoutId`: 運動ID（成功時のみ）
  - `error`: エラーメッセージ（失敗時のみ）

---

#### 3.2.13 tryStartWorkoutWithGoal()
**概要**: 目標の運動種別で運動を開始

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. ユーザーの目標運動種別を取得
2. startWorkoutメソッドを呼び出し
3. 成功時：StartWorkoutResult（成功=true、運動ID、エラー=null）を返却
4. 失敗時：StartWorkoutResult（成功=false、運動ID=null、エラーメッセージ）を返却

**出力パラメータ**:
- 戻り値: `StartWorkoutResult` - 運動開始結果
  - `success`: 成功フラグ（boolean）
  - `workoutId`: 運動ID（成功時のみ）
  - `error`: エラーメッセージ（失敗時のみ）

---

#### 3.2.14 getInProgressData()
**概要**: 運動中画面のデータを取得

**入力パラメータ**:
- `String userId` - ユーザーID
- `String workoutId` - 運動ID

**具体的処理内容**:
1. 指定された運動IDの運動記録を取得
2. 運動記録が存在しない、または進行中でない場合は無効な結果を返却
3. ユーザーの目標運動時間を取得
4. ユーザー名を取得
5. InProgressResultを作成して返却

**出力パラメータ**:
- 戻り値: `InProgressResult` - 運動中画面データ
  - `valid`: 有効なデータかどうか（boolean）
  - `workout`: 運動記録（Workout）
  - `targetSessionTime`: 目標運動時間（分）
  - `userName`: ユーザー名（String）

---

#### 3.2.15 getCompleteData()
**概要**: 運動完了画面のデータを取得

**入力パラメータ**:
- `String userId` - ユーザーID
- `String workoutId` - 運動ID

**具体的処理内容**:
1. 指定された運動IDの運動記録を取得
2. 運動記録が存在しない、または進行中でない場合は無効な結果を返却
3. 開始時刻から現在時刻までの運動時間を計算
4. 運動時間をHH:mm形式にフォーマット
5. CompleteResultを作成して返却

**出力パラメータ**:
- 戻り値: `CompleteResult` - 運動完了画面データ
  - `valid`: 有効なデータかどうか（boolean）
  - `workout`: 運動記録（Workout）
  - `workoutDuration`: 運動時間（HH:mm形式）

---

#### 3.2.16 tryCompleteWorkout()
**概要**: 運動完了を試行

**入力パラメータ**:
- `String userId` - ユーザーID
- `String workoutId` - 運動ID
- `String comment` - 運動コメント

**具体的処理内容**:
1. completeWorkoutメソッドを呼び出し
2. バディへの通知を送信
3. 成功時：CompleteWorkoutResult（成功=true、エラー=null）を返却
4. 失敗時：CompleteWorkoutResult（成功=false、エラーメッセージ）を返却

**出力パラメータ**:
- 戻り値: `CompleteWorkoutResult` - 運動完了処理結果
  - `success`: 成功フラグ（boolean）
  - `error`: エラーメッセージ（失敗時のみ）

---

#### 3.2.17 tryAddReaction()
**概要**: リアクション追加を試行

**入力パラメータ**:
- `String userId` - リアクション送信者ID
- `Map<String, Object> request` - リアクション情報を含むリクエストマップ

**具体的処理内容**:
1. リクエストから運動IDとリアクション種別を取得
2. addReactionメソッドを呼び出し
3. 運動記録を取得し、自分以外の運動の場合に通知を作成
4. 成功時：ReactionResult（成功=true、メッセージ）を返却
5. 失敗時：ReactionResult（成功=false、エラーメッセージ）を返却

**出力パラメータ**:
- 戻り値: `ReactionResult` - リアクション結果
  - `success`: 成功フラグ（boolean）
  - `message`: 結果メッセージ（String）

---

#### 3.2.18 getRecordsData()
**概要**: 運動記録一覧データを取得

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. ユーザーの運動記録を取得
2. ユーザー名を取得
3. RecordsResultを作成して返却

**出力パラメータ**:
- 戻り値: `RecordsResult` - 運動記録一覧データ
  - `workouts`: 運動記録リスト（List<Workout>）
  - `userName`: ユーザー名（String）

---

## 4. WorkoutRepository クラス

### 4.1 クラス概要
運動記録のデータベースアクセスを担当するリポジトリクラスです。

### 4.2 メソッド仕様

#### 4.2.1 findByUserIdOrderByWorkoutDateDesc()
**概要**: ユーザーIDで運動記録を取得（運動日降順）

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. 指定されたユーザーIDの運動記録を運動日の降順で検索
2. 結果を返却

**出力パラメータ**:
- 戻り値: `List<Workout>` - 運動記録のリスト（運動日降順）

---

#### 4.2.2 findByUserIdAndDateRange()
**概要**: ユーザーIDと日付範囲で運動記録を取得

**入力パラメータ**:
- `String userId` - ユーザーID
- `LocalDate startDate` - 開始日
- `LocalDate endDate` - 終了日

**具体的処理内容**:
1. 指定された期間内の運動記録を検索
2. 結果を返却

**出力パラメータ**:
- 戻り値: `List<Workout>` - 期間内の運動記録リスト

---

#### 4.2.3 findByUserIdAndWorkoutDate()
**概要**: ユーザーIDと日付で運動記録を取得

**入力パラメータ**:
- `String userId` - ユーザーID
- `LocalDate workoutDate` - 運動日

**具体的処理内容**:
1. 指定された日付の運動記録を検索
2. 結果を返却

**出力パラメータ**:
- 戻り値: `List<Workout>` - 指定日の運動記録リスト

---

#### 4.2.4 countByUserIdAndDate()
**概要**: ユーザーIDと日付で運動記録数をカウント

**入力パラメータ**:
- `String userId` - ユーザーID
- `LocalDate date` - 対象日

**具体的処理内容**:
1. 指定された日付の運動記録数をカウント
2. 結果を返却

**出力パラメータ**:
- 戻り値: `int` - 運動記録数

---

#### 4.2.5 findByUserIdAndStatus()
**概要**: 進行中の運動記録を取得

**入力パラメータ**:
- `String userId` - ユーザーID
- `String status` - 運動ステータス（通常は"in_progress"）

**具体的処理内容**:
1. 指定されたユーザーの指定ステータスの運動記録を検索
2. 結果を返却（存在しない場合は空のOptional）

**出力パラメータ**:
- 戻り値: `Optional<Workout>` - 進行中の運動記録（存在しない場合は空）

---

#### 4.2.6 findByUserIdAndStatusOrderByWorkoutDateDesc()
**概要**: 完了済みの運動記録を取得（運動日降順）

**入力パラメータ**:
- `String userId` - ユーザーID
- `String status` - 運動ステータス（通常は"completed"）

**具体的処理内容**:
1. 指定されたユーザーの指定ステータスの運動記録を運動日の降順で検索
2. 結果を返却

**出力パラメータ**:
- 戻り値: `List<Workout>` - 完了済み運動記録のリスト（運動日降順）

---

#### 4.2.7 countDistinctWorkoutDays()
**概要**: 期間内の運動日数をカウント（重複排除）

**入力パラメータ**:
- `String userId` - ユーザーID
- `LocalDate startDate` - 開始日
- `LocalDate endDate` - 終了日

**具体的処理内容**:
1. 指定された期間内の運動日数を重複を除いてカウント
2. 結果を返却

**出力パラメータ**:
- 戻り値: `int` - 運動日数（重複排除済み）

---

#### 4.2.8 save()
**概要**: 運動記録を保存

**入力パラメータ**:
- `Workout workout` - 保存する運動記録

**具体的処理内容**:
1. 既存の運動記録をチェック
2. 新規作成の場合：INSERT文を実行
3. 既存レコードの場合：UPDATE文を実行
4. 保存された運動記録を返却

**出力パラメータ**:
- 戻り値: `Workout` - 保存された運動記録

---

#### 4.2.9 findById()
**概要**: 運動記録をIDで取得

**入力パラメータ**:
- `String workoutId` - 運動ID

**具体的処理内容**:
1. 指定された運動IDの運動記録を検索
2. 結果を返却（存在しない場合は空のOptional）

**出力パラメータ**:
- 戻り値: `Optional<Workout>` - 運動記録（存在しない場合は空）

---

## 5. Workout エンティティクラス

### 5.1 クラス概要
ユーザーの運動記録を表現するエンティティクラスです。

### 5.2 メソッド仕様

#### 5.2.1 isInProgress()
**概要**: 運動が進行中かどうかを判定

**入力パラメータ**:
- なし

**具体的処理内容**:
1. 運動ステータスが"in_progress"かどうかをチェック
2. 結果を返却

**出力パラメータ**:
- 戻り値: `boolean` - 進行中の場合はtrue、そうでなければfalse

---

#### 5.2.2 isCompleted()
**概要**: 運動が完了しているかどうかを判定

**入力パラメータ**:
- なし

**具体的処理内容**:
1. 運動ステータスが"completed"かどうかをチェック
2. 結果を返却

**出力パラメータ**:
- 戻り値: `boolean` - 完了している場合はtrue、そうでなければfalse

---

#### 5.2.3 getDurationMinutes()
**概要**: 運動時間を分単位で取得

**入力パラメータ**:
- なし

**具体的処理内容**:
1. durationSecondsを60で割って分単位に変換
2. durationSecondsがnullの場合は0を返却
3. 結果を返却

**出力パラメータ**:
- 戻り値: `Integer` - 運動時間（分）

---

## 6. WorkoutDto クラス

### 6.1 クラス概要
運動記録のデータを画面間で転送するためのDTOクラスです。

### 6.2 フィールド仕様

#### 6.2.1 フィールド一覧
- `workoutId`: 運動ID（String）
- `userId`: ユーザーID（String）
- `workoutDate`: 運動日（文字列形式、String）
- `startTime`: 運動開始時刻（文字列形式、String）
- `endTime`: 運動終了時刻（文字列形式、String）
- `durationSeconds`: 運動時間（秒、Integer）
- `exerciseType`: 運動種別（String）
- `comment`: 運動に関するコメント（String）
- `status`: 運動ステータス（String）
- `createdAt`: 作成日時（文字列形式、String）

---

## 7. 内部クラス仕様

### 7.1 WorkoutService.StartWorkoutResult
**概要**: 運動開始結果を表すDTO

**フィールド**:
- `success`: 成功フラグ（boolean）
- `workoutId`: 運動ID（成功時のみ、String）
- `error`: エラーメッセージ（失敗時のみ、String）

### 7.2 WorkoutService.InProgressResult
**概要**: 運動中画面データを表すDTO

**フィールド**:
- `valid`: 有効なデータかどうか（boolean）
- `workout`: 運動記録（Workout）
- `targetSessionTime`: 目標運動時間（分、int）
- `userName`: ユーザー名（String）

### 7.3 WorkoutService.CompleteResult
**概要**: 運動完了画面データを表すDTO

**フィールド**:
- `valid`: 有効なデータかどうか（boolean）
- `workout`: 運動記録（Workout）
- `workoutDuration`: 運動時間（HH:mm形式、String）

### 7.4 WorkoutService.CompleteWorkoutResult
**概要**: 運動完了処理結果を表すDTO

**フィールド**:
- `success`: 成功フラグ（boolean）
- `error`: エラーメッセージ（失敗時のみ、String）

### 7.5 WorkoutService.ReactionResult
**概要**: リアクション結果を表すDTO

**フィールド**:
- `success`: 成功フラグ（boolean）
- `message`: 結果メッセージ（String）

### 7.6 WorkoutService.RecordsResult
**概要**: 運動記録一覧データを表すDTO

**フィールド**:
- `workouts`: 運動記録リスト（List<Workout>）
- `userName`: ユーザー名（String）

---

## 8. エラー処理仕様

### 8.1 共通エラー処理
- **ユーザー未ログイン**: ログイン画面にリダイレクト
- **無効な運動データ**: ホーム画面にリダイレクト
- **目標未設定**: 目標設定画面にリダイレクト
- **進行中運動重複**: エラーメッセージと共に開始画面にリダイレクト

### 8.2 例外処理
- **RuntimeException**: ビジネスロジックエラー
- **SQLException**: データベースエラー
- **ValidationException**: 入力値検証エラー

---

## 9. パフォーマンス考慮事項

### 9.1 データベース最適化
- インデックスの活用（user_id, workout_date, status）
- 適切なクエリの使用（DISTINCT、ORDER BY）
- トランザクション境界の設定

### 9.2 メモリ使用量
- 大量データのページネーション対応
- 不要なオブジェクトの早期解放
- 効率的なデータ構造の使用

---

## 10. セキュリティ考慮事項

### 10.1 認証・認可
- セッション管理によるユーザー認証
- 運動記録の所有者確認
- 適切なアクセス制御

### 10.2 データ保護
- SQLインジェクション対策（PreparedStatement使用）
- 入力値の適切な検証
- 機密情報の暗号化

---

## 11. テスト仕様

### 11.1 単体テスト
- 各メソッドの正常系・異常系テスト
- 境界値テスト
- モックオブジェクトの活用

### 11.2 統合テスト
- エンドツーエンドテスト
- データベース連携テスト
- セッション管理テスト

---

## 12. 運用・保守考慮事項

### 12.1 ログ出力
- 重要な処理のログ記録
- エラー時の詳細ログ
- パフォーマンス監視ログ

### 12.2 監視・アラート
- データベース接続監視
- レスポンス時間監視
- エラー率監視

---

**作成者**: nagahama  
**作成日**: 2024年1月1日  
**バージョン**: 1.0 