# 目標設定機能メソッド仕様書

## 1. 概要

本仕様書は、運動バディアプリの目標設定機能（目標設定・取得・履歴・削除等）に関する全てのメソッドについて、入力パラメータ、具体的処理内容、出力パラメータを詳細に記述したものです。

### 1.1 対象クラス
- `GoalController` - 目標設定機能のコントローラー
- `GoalService` - 目標設定機能のビジネスロジック
- `UserGoalRepository` - 目標設定のデータアクセス層
- `GoalEntity` - 目標設定Entity
- `GoalDto` - 目標設定DTO

---

## 2. GoalController クラス

### 2.1 クラス概要
目標設定機能のHTTPリクエストを処理するコントローラークラスです。

### 2.2 メソッド仕様

#### 2.2.1 showGoalSettingForm()
**概要**: 目標設定画面を表示

**入力パラメータ**:
- `Model model` - Spring MVCのモデル
- `HttpSession session` - HTTPセッション

**具体的処理内容**:
1. セッションからユーザーIDを取得
2. 未ログインの場合はログイン画面にリダイレクト
3. GoalServiceのgetGoalDtoForUserを呼び出し、現在の目標情報を取得
4. モデルに目標DTOを追加し、設定画面を返却

**出力パラメータ**:
- 戻り値: `String` - テンプレート名（"goal/set" または "redirect:/login"）

---

#### 2.2.2 setGoal()
**概要**: 目標設定処理

**入力パラメータ**:
- `GoalDto goalDto` - 目標設定データ（バリデーション済み）
- `BindingResult bindingResult` - バリデーション結果
- `Model model` - Spring MVCのモデル
- `HttpSession session` - HTTPセッション
- `RedirectAttributes redirectAttributes` - リダイレクト時の属性

**具体的処理内容**:
1. セッションからユーザーIDを取得
2. 未ログインの場合はログイン画面にリダイレクト
3. バリデーションエラーがある場合は設定画面に戻る
4. GoalServiceのsetGoalを呼び出し、目標を保存
5. 成功時：成功メッセージを設定しホーム画面にリダイレクト
6. 失敗時：エラーメッセージを設定し設定画面に戻る

**出力パラメータ**:
- 戻り値: `String` - テンプレート名またはリダイレクト先のURL

---


## 3. GoalService クラス

### 3.1 クラス概要
目標設定機能のビジネスロジックを提供するサービスクラスです。

### 3.2 メソッド仕様

#### 3.2.1 setGoal()
**概要**: 目標設定

**入力パラメータ**:
- `String userId` - ユーザーID
- `GoalDto goalDto` - 目標設定データ

**具体的処理内容**:
1. 既存のアクティブな目標を非アクティブ化
2. 新しい目標エンティティを作成
3. 目標DTOの値をエンティティに設定
4. 作成日時・更新日時を現在時刻に設定
5. アクティブフラグをtrueに設定
6. 目標を保存

**出力パラメータ**:
- 戻り値: `void`（例外発生時はRuntimeException）

---

#### 3.2.2 getCurrentGoal()
**概要**: 現在の目標を取得

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. ユーザーIDでアクティブな目標を検索
2. 見つかった場合は目標エンティティを返却
3. 見つからない場合はnullを返却

**出力パラメータ**:
- 戻り値: `UserGoal` - 現在の目標（存在しない場合はnull）

---


#### 3.2.4 hasActiveGoal()
**概要**: 目標が設定されているかチェック

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. ユーザーIDでアクティブな目標の存在をチェック

**出力パラメータ**:
- 戻り値: `boolean` - アクティブな目標が存在する場合true

---

#### 3.2.5 deleteGoal()
**概要**: 目標を削除（非アクティブ化）

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. ユーザーIDでアクティブな目標を検索
2. 見つかった場合は非アクティブ化
3. 更新日時を現在時刻に設定
4. 目標を保存

**出力パラメータ**:
- 戻り値: `void`（例外発生時はRuntimeException）

---

#### 3.2.6 getGoalDtoForUser()
**概要**: 既存の目標をDTOで返す（なければ空のDTO）

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. 現在の目標を取得
2. 目標が存在する場合はDTOに変換して返却
3. 目標が存在しない場合または例外発生時は空のDTOを返却

**出力パラメータ**:
- 戻り値: `GoalDto` - 目標DTO（存在しない場合は空のDTO）

---


## 4. UserGoalRepository クラス

### 4.1 クラス概要
目標設定のデータベースアクセスを担当するリポジトリクラスです。

### 4.2 メソッド仕様

#### 4.2.1 findActiveGoalByUserId()
**概要**: ユーザーIDでアクティブな目標を取得

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. 指定ユーザーのアクティブな目標を検索
2. 結果を返却

**出力パラメータ**:
- 戻り値: `Optional<UserGoal>` - アクティブな目標（存在しない場合は空）

---


#### 4.2.4 existsByUserIdAndIsActiveTrue()
**概要**: ユーザーIDで目標が存在するかチェック

**入力パラメータ**:
- `String userId` - ユーザーID

**具体的処理内容**:
1. 指定ユーザーのアクティブな目標の有無をカウント

**出力パラメータ**:
- 戻り値: `boolean` - 存在する場合true

---

#### 4.2.5 save()
**概要**: 目標を保存

**入力パラメータ**:
- `UserGoal goal` - 目標エンティティ

**具体的処理内容**:
1. 新規作成時はINSERT、既存時はUPDATE
2. 保存後のエンティティを返却

**出力パラメータ**:
- 戻り値: `UserGoal` - 保存されたエンティティ

---

## 5. UserGoal エンティティ
# GoalEntityにクラス名変更

### 5.1 クラス概要
ユーザーの目標設定を表現するエンティティクラスです。

### 5.2 フィールド仕様
- `goalId`: 目標ID（Long）
- `userId`: ユーザーID（String）
- `goalDuration`: 目標期間（String） ＊型は数値の方が便利そう
- `weeklyFrequency`: 週間頻度（Integer）
- `exerciseType`: 運動種別（String）
- `sessionTimeMinutes`: セッション時間（分）（Integer）
- `createdAt`: 作成日時（LocalDateTime）
- `updatedAt`: 更新日時（LocalDateTime）
- `isActive`: アクティブフラグ（Boolean）
- `user`: ユーザー情報（User）

---

## 6. GoalDto クラス

### 6.1 クラス概要
目標設定データを画面間で転送するためのDTOクラスです。

### 6.2 フィールド仕様
- `goalId`: 目標ID（Long）
- `userId`: ユーザーID（String）
- `goalDuration`: 目標期間（String）
- `weeklyFrequency`: 週間頻度（Integer）
- `exerciseType`: 運動種別（String）
- `sessionTimeMinutes`: セッション時間（分）（Integer）
- `isActive`: アクティブフラグ（Boolean）
- `createdAt`: 作成日時（String）
- `updatedAt`: 更新日時（String）

---

## 7. 共通エラー処理

### 7.1 例外処理
- **RuntimeException**: データベースエラー、バリデーションエラー等
- **NullPointerException**: 必須パラメータがnullの場合
- **IllegalArgumentException**: 不正なパラメータ値の場合

### 7.2 エラーハンドリング
- コントローラー層で例外をキャッチし、適切なエラーメッセージを表示
- サービス層で例外をラップし、具体的なエラー内容を上位に伝播
- リポジトリ層でデータベース例外を適切に処理

---

## 8. パフォーマンス考慮事項

### 8.1 データベース最適化
- アクティブな目標の検索にインデックスを設定
- 目標履歴の取得時にページネーションを検討
- 不要なデータの削除（物理削除）を定期的に実行

### 8.2 キャッシュ戦略
- 現在の目標情報をセッションにキャッシュ
- 目標履歴の表示時に適切なキャッシュを検討

---

## 9. セキュリティ考慮事項

### 9.1 認証・認可
- 全ての目標設定機能でユーザー認証を必須とする
- 自分の目標のみアクセス可能とする
- セッション管理を適切に行う

### 9.2 データ保護
- 目標データの暗号化を検討
- 個人情報の適切な取り扱い
- ログ出力時の個人情報保護

---

## 10. テスト仕様

### 10.1 単体テスト
- 各メソッドの正常系・異常系テスト
- バリデーション機能のテスト
- データベース操作のテスト

### 10.2 統合テスト
- コントローラー・サービス・リポジトリ間の連携テスト
- 画面遷移のテスト
- データベーストランザクションのテスト

---

**作成者**: cursor
**作成日**: 2024年1月1日  
**バージョン**: 1.0 